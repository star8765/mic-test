<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Mic Visual</title>
    <link rel="manifest" href="manifest.json" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- âœ… ã‚¹ãƒãƒ›å¯¾å¿œè¨­å®š -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <style>
      /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }

      #fullscreen {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: black; /* å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ */
      }

      #startBtn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 1em 2em;
        font-size: 20px;
        background: white;
        border: none;
        border-radius: 8px;
        z-index: 100;
      }

      .log {
        color: white;
        font-size: 14px;
        margin: 4px;
      }

      #palette {
        position: absolute;
        top: 30px;
        left: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        z-index: 99;
      }

      .colorBtn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid white;
        outline: none;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .colorBtn.selected {
        border: 3px solid white;
        transform: scale(1.3);
      }
      .fs-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border: none;
        border-radius: 30px;
        background-color: rgba(255, 255, 255, 0.9);
        color: black;
        font-size: 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 1000;
        transition: opacity 0.5s ease;
      }
      .fs-exit-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border: none;
        border-radius: 30px;
        background-color: rgba(255, 255, 255, 0.9);
        color: black;
        font-size: 24px;
        display: none; /* â† åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 1000;
        transition: opacity 0.5s ease;
      }

      #memo {
        position: absolute;
        top: 80px; /* ãƒ‘ãƒ¬ãƒƒãƒˆãŒ top: 30px ãªã®ã§ã€ãã®ä¸‹ã‚ãŸã‚Š */
        left: 10px;
        color: white;
        font-size: 14px;
        background: transparent;
        z-index: 99;
      }
    </style>
  </head>
  <body>
    <button id="startBtn">Tap to Start Mic</button>
    <div id="palette"></div>
    <div id="memo">æ›´æ–°ãƒ¡ãƒ¢ï¼š7/31 0.9ã€ã‚ªãƒ¼ãƒˆã‚²ã‚¤ãƒ³ã‚ªãƒ•</div>
    <button class="fs-button" onclick="enterFullScreen()">
      <i class="fa-solid fa-up-right-and-down-left-from-center"></i>
    </button>
    <button class="fs-exit-button" onclick="exitFullScreen()">
      <i class="fa-solid fa-down-left-and-up-right-to-center"></i>
    </button>

    <script>
      const colorOptions = [
        "#FFD93D",
        "#3ABEFF",
        "#A3F948",
        "#FF7CA3",
        "#B067D1",
        "#2EC27E",
        "#FF914D",
        "#FFFFFF",
      ];
      let selectedColor = colorOptions[0];

      const startBtn = document.getElementById("startBtn");
      const palette = document.getElementById("palette");
      let audioContext,
        analyser,
        micSource,
        dataArray,
        smoothRMS = 0;

      let wakeLock = null;

      // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³é–‹å§‹
      async function enterFullScreen() {
        const element = document.documentElement;

        if (element.requestFullscreen) {
          await element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
          await element.webkitRequestFullscreen();
        }

        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®åˆ‡æ›¿
        document.querySelector(".fs-button").style.display = "none";
        document.querySelector(".fs-exit-button").style.display = "flex";

        // ğŸ”’ Wake Lockï¼ˆã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼‰ã‚’è¦æ±‚
        try {
          if ("wakeLock" in navigator) {
            wakeLock = await navigator.wakeLock.request("screen");
            console.log("Wake Lock æœ‰åŠ¹");
          }
        } catch (err) {
          console.error("Wake Lock ã‚¨ãƒ©ãƒ¼:", err);
        }
      }

      // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤
      async function exitFullScreen() {
        if (document.exitFullscreen) {
          await document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          await document.webkitExitFullscreen();
        }

        document.querySelector(".fs-exit-button").style.display = "none";
        document.querySelector(".fs-button").style.display = "flex";

        // ğŸ”“ Wake Lock è§£é™¤
        if (wakeLock !== null) {
          try {
            await wakeLock.release();
            wakeLock = null;
            console.log("Wake Lock è§£é™¤");
          } catch (err) {
            console.error("Wake Lock è§£æ”¾ã‚¨ãƒ©ãƒ¼:", err);
          }
        }
      }

      // ğŸ¨ ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆ
      colorOptions.forEach((color) => {
        const btn = document.createElement("button");
        btn.className = "colorBtn";
        btn.style.backgroundColor = color;
        btn.setAttribute("data-color", color);
        btn.onclick = () => {
          selectedColor = color;
          updatePalette();
        };
        palette.appendChild(btn);
      });

      function updatePalette() {
        document.querySelectorAll(".colorBtn").forEach((btn) => {
          if (btn.getAttribute("data-color") === selectedColor) {
            btn.classList.add("selected");
          } else {
            btn.classList.remove("selected");
          }
        });
      }

      updatePalette();

      startBtn.addEventListener("click", async () => {
        startBtn.style.display = "none";

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });

          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;

          micSource.connect(analyser);

          dataArray = new Uint8Array(analyser.fftSize);

          animate();
        } catch (err) {
          alert("ãƒã‚¤ã‚¯å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        }
      });

      function animate() {
        requestAnimationFrame(animate);
        analyser.getByteTimeDomainData(dataArray);

        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          let val = dataArray[i] - 128;
          sum += val * val;
        }

        let rms = Math.sqrt(sum / dataArray.length);
        // éŸ³ã®å¼·ã•ã‚’è¨ˆç®—ï¼ˆrmsï¼‰ã—ãŸã‚ã¨
        if (rms > smoothRMS) {
          // éŸ³ãŒå¤§ãããªã£ãŸã¨ãã¯å³è¿½å¾“
          smoothRMS = rms;
        } else {
          // éŸ³ãŒå°ã•ããªã£ãŸã¨ãã¯ãªã‚ã‚‰ã‹ã«æ¸›è¡°
          smoothRMS = smoothRMS * 0.9 + rms * 0.1;
        }

        const GAIN_MULTIPLIER = 20;
        const BASE_BLEND = 0.1; // â† ã“ã‚ŒãŒ HSL ã® BASE_LIGHTNESS ã«ç›¸å½“ï¼ˆ0ã€œ1ï¼‰
        const MAX_BLEND_RANGE = 0.9; // â† ã“ã‚ŒãŒ LIGHTNESS_RANGE ã«ç›¸å½“ï¼ˆ0ã€œ1ï¼‰

        // æ˜æ»…å‰²åˆï¼ˆ0ã€œ1ï¼‰
        let brightness = Math.min(1, (smoothRMS * GAIN_MULTIPLIER) / 128);
        // blendç‡ã‚’HSLçš„ã«å†æ§‹æˆ
        let blend = BASE_BLEND + brightness * MAX_BLEND_RANGE;
        blend = Math.min(1, blend); // å¿µã®ãŸã‚åˆ¶é™

        const target = hexToRgb(selectedColor);
        const base = { r: 55, g: 55, b: 55 }; // â† æ˜ã‚‹ã‚ã®ã‚°ãƒ¬ãƒ¼ã€œç™½èƒŒæ™¯

        const lerpColor = {
          r: Math.round(base.r + (target.r - base.r) * blend),
          g: Math.round(base.g + (target.g - base.g) * blend),
          b: Math.round(base.b + (target.b - base.b) * blend),
        };

        document.body.style.backgroundColor = `rgb(${lerpColor.r}, ${lerpColor.g}, ${lerpColor.b})`;
      }

      function hexToRgb(hex) {
        return {
          r: parseInt(hex.slice(1, 3), 16),
          g: parseInt(hex.slice(3, 5), 16),
          b: parseInt(hex.slice(5, 7), 16),
        };
      }

      // ğŸ¨ hex â†’ HSL
      function rgbToHslString(hex) {
        let r = parseInt(hex.slice(1, 3), 16) / 255;
        let g = parseInt(hex.slice(3, 5), 16) / 255;
        let b = parseInt(hex.slice(5, 7), 16) / 255;

        let max = Math.max(r, g, b),
          min = Math.min(r, g, b);
        let h,
          s,
          l = (max + min) / 2;

        if (max === min) {
          h = s = 0;
        } else {
          let d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r:
              h = (g - b) / d + (g < b ? 6 : 0);
              break;
            case g:
              h = (b - r) / d + 2;
              break;
            case b:
              h = (r - g) / d + 4;
              break;
          }
          h *= 60;
        }

        return {
          h: Math.round(h),
          s: Math.round(s * 100),
          l: Math.round(l * 100),
        };
      }
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => {
            console.log("Service Worker ç™»éŒ²å®Œäº†");
          })
          .catch((err) => {
            console.error("Service Worker ç™»éŒ²å¤±æ•—:", err);
          });
      }
    </script>
  </body>
</html>
